<!DOCTYPE html>
<html>

<head>
    <title>Borrower Panel</title>
</head>

<body>
    <h2>Borrower Financial Profile POST</h2>
    <form id="finForm">
        Yearly Income: <input type="number" name="yearly_income" required><br>
        Occupation: <input type="text" name="occupation" required><br>
        Employer: <input type="text" name="employer" required><br>
        Existing Loan EMIs: <input type="number" name="existing_loan_emis" value="0"><br>
        GST No: <input type="text" name="gst_no"><br>
        <button type="submit">Submit Profile</button>
    </form>
    <div id="finResult"></div>

    <br>
    <hr><br>
    <h2>Request Loan POST</h2>
    <form id="loanForm">
        Amount (USDC): <input type="number" id="loanAmount" name="amount" required><br>
        Tenure (Months): <input type="number" id="loanTenure" name="tenure" required><br>
        Purpose: <input type="text" name="purpose" required><br>
        Consent Credit Check: <input type="checkbox" name="credit_check_consent" value="true"><br>
        Consent Auto Debit: <input type="checkbox" name="auto_debit_consent" value="true"><br>
        <strong>Estimated Monthly EMI (16% APY): <span id="emiDisplay">$0.00</span></strong><br><br>
        <button type="submit">Submit Loan Request</button>
    </form>
    <div id="loanResult"></div>

    <br><a href="/home/">Go to Home</a>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login/';

        document.getElementById('finForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            document.getElementById('finResult').innerText = "Loading...";
            const res = await fetch('/api/financial-profile/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            document.getElementById('finResult').innerHTML = "<pre>" + JSON.stringify(json, null, 2) + "</pre>";
        });

        document.getElementById('loanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            data.credit_check_consent = !!e.target.credit_check_consent.checked;
            data.auto_debit_consent = !!e.target.auto_debit_consent.checked;

            document.getElementById('loanResult').innerText = "Loading...";
            const res = await fetch('/api/loan-request/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` },
                body: JSON.stringify(data)
            });
            document.getElementById('loanResult').innerHTML = "<pre>" + JSON.stringify(json, null, 2) + "</pre>";
        });

        // Real-time EMI Calculation
        function calculateEMI() {
            const amountInput = document.getElementById('loanAmount').value;
            const tenureInput = document.getElementById('loanTenure').value;

            if (amountInput && tenureInput && amountInput > 0 && tenureInput > 0) {
                const P = parseFloat(amountInput);
                const n = parseInt(tenureInput);
                const r = 0.16 / 12; // 16% annual interest rate divided by 12 months

                // EMI formula: P * r * (1 + r)^n / ((1 + r)^n - 1)
                const emi = (P * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);

                document.getElementById('emiDisplay').innerText = `$${emi.toFixed(2)}`;
            } else {
                document.getElementById('emiDisplay').innerText = `$0.00`;
            }
        }

        document.getElementById('loanAmount').addEventListener('input', calculateEMI);
        document.getElementById('loanTenure').addEventListener('input', calculateEMI);
    </script>
</body>

</html>